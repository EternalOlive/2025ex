<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유치원 급식사생대회 3D 전시장</title>
    <link rel="stylesheet" href="./css/style.css">
    <link href="../assets/css/index.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../assets/css/prize_sector.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .comment-content,
        .comment-date {
            text-align: left;
        }

        /* 뒤로가기 버튼 스타일 */
        #back-button {
            position: fixed;
            top: 21px;
            left: 20px;
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #back-button:hover {
            background: rgba(255, 255, 255, 1);
        }

        #back-button:active {
            transform: scale(0.95);
            background: rgba(240, 240, 240, 1);
        }

        /* 홈 아이콘 */
        .home-icon {
            font-size: 18px;
            color: #333;
        }

        /* 심플한 로딩 화면 스타일 */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-title {
            font-size: 1.8rem;
            font-weight: 400;
            margin-bottom: 30px;
            color: #555;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #6c757d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-text {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 300;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
                touch-action: none;
                -webkit-overflow-scrolling: none;
            }
            
            html {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            .loading-title {
                font-size: 1.5rem;
            }
            
            .spinner {
                width: 35px;
                height: 35px;
            }

            #back-button {
                display: flex;
                top: auto;
                left: auto;
                bottom: 20px;
                right: 20px;
                width: 35px !important;
                height: 35px !important;
            }

            .home-icon {
                font-size: 16px !important;
            }

            /* 모바일 도움말 버튼 */
            #help-button {
                display: flex !important;
                position: fixed !important;
                top: auto !important;
                left: auto !important;
                bottom: 65px !important;
                right: 20px !important;
                width: 35px !important;
                height: 35px !important;
                font-size: 16px !important;
            }
        }

        #joystick-knob:active {
            cursor: grabbing;
            transform: translate(-16px,-16px) scale(0.9);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase 클라이언트 초기화 스크립트 -->
    <script>
        // Supabase 클라이언트 전역 생성 (한 번만)
        const SUPABASE_URL = 'https://pimgwrosozsowpetqeeq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpbWd3cm9zb3pzb3dwZXRxZWVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MTcxMjgsImV4cCI6MjA3MDk5MzEyOH0.VKEsxMu47TDVvV93Gy9I-z4UmfNYlNEhSYkBSS5vDqU';
        
        // 전역 Supabase 클라이언트 인스턴스 (페이지당 한 번만 생성)
        window.globalSupabaseClient = null;
        
        // Supabase 클라이언트 초기화 함수
        function initSupabaseClient() {
            if (!window.globalSupabaseClient && window.supabase && typeof window.supabase.createClient === 'function') {
                try {
                    window.globalSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('Supabase 클라이언트 초기화 완료 (model.html)');
                } catch (error) {
                    console.error('Supabase 클라이언트 초기화 실패:', error);
                }
            }
            return window.globalSupabaseClient;
        }

        // Supabase 클라이언트 가져오기 함수
        function getSupabaseClient() {
            if (window.globalSupabaseClient) {
                return window.globalSupabaseClient;
            }
            return initSupabaseClient();
        }

        // 댓글 섹션 HTML 생성
        function createCommentSection(itemId) {
            // itemId를 안전한 CSS 선택자용 ID로 변환
            const safeId = itemId.replace(/[^a-zA-Z0-9_-]/g, '_');
            
            const container = document.createElement('div');
            container.className = 'comment-section';
            container.innerHTML = `
                <h3>댓글 <span class="comment-count" id="comment-count-${safeId}">(0)</span></h3>
                
                <div class="comments-list" id="comments-list-${safeId}">
                    <div class="no-comments">작성된 댓글이 없습니다.</div>
                </div>
                
                <div class="comment-form">
                    <input 
                        type="text"
                        id="comment-author-${safeId}"
                        placeholder="작성자 이름"
                        maxlength="8"
                        class="comment-author-input"
                        style="margin-bottom:12px;width:100%;box-sizing:border-box;border-radius:8px;padding:12px 16px;border:1.5px solid #d1d5db;font-size:16px;background:#f8f9fa;transition:border-color 0.2s;"
                    />
                    <textarea 
                        id="comment-content-${safeId}" 
                        placeholder="댓글을 작성해주세요 (최대 300자)" 
                        maxlength="300"
                        rows="3"
                    ></textarea>
                    <div class="comment-form-bottom">
                        <span class="char-count" id="char-count-${safeId}">0/300</span>
                        <button class="comment-submit" onclick="submitComment('${itemId}')">댓글 작성</button>
                    </div>
                </div>
            `;
            
            // 글자 수 카운터 이벤트 리스너 추가
            const textarea = container.querySelector(`#comment-content-${safeId}`);
            const charCount = container.querySelector(`#char-count-${safeId}`);
            const submitBtn = container.querySelector('.comment-submit');
            
            if (textarea && charCount && submitBtn) {
                textarea.addEventListener('input', function() {
                    const length = this.value.length;
                    charCount.textContent = `${length}/300`;
                    charCount.className = length > 250 ? 'char-count warning' : 'char-count';
                    submitBtn.disabled = length === 0 || length > 300;
                });
            }
            
            return container;
        }

        // 댓글 불러오기 (Supabase 연결)
        async function loadComments(itemId) {
            // itemId를 안전한 CSS 선택자용 ID로 변환
            const safeId = itemId.replace(/[^a-zA-Z0-9_-]/g, '_');
            
            const commentsList = document.getElementById(`comments-list-${safeId}`);
            const commentCount = document.getElementById(`comment-count-${safeId}`);
            
            try {
                // 전역 Supabase 클라이언트 사용
                const supabaseClient = getSupabaseClient();
                
                if (!supabaseClient) {
                    throw new Error('Supabase 클라이언트를 초기화할 수 없습니다.');
                }
                
                const { data: comments, error } = await supabaseClient
                    .from('comments')
                    .select('*')
                    .eq('item_id', itemId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Supabase 댓글 로드 오류:', error);
                    throw error;
                }
                
                if (commentCount) {
                    commentCount.textContent = `(${comments.length})`;
                }
                
                if (commentsList) {
                    if (comments.length === 0) {
                        commentsList.innerHTML = '<div class="no-comments">아직 댓글이 없습니다. 첫 댓글을 작성해보세요!</div>';
                    } else {
                        commentsList.innerHTML = comments.map(comment => {
                            const date = new Date(comment.created_at).toLocaleString('ko-KR', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            // HTML 이스케이프
                            const escapeHtml = (text) => {
                                const map = {
                                    '&': '&amp;',
                                    '<': '&lt;',
                                    '>': '&gt;',
                                    '"': '&quot;',
                                    "'": '&#039;'
                                };
                                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
                            };
                            return `
                                <div class="comment-item" style="display:flex;justify-content:space-between;align-items:center;">
                                    <div style="flex:1;">
                                        <div class="comment-content">${escapeHtml(comment.content)}</div>
                                        <div class="comment-date">${date}</div>
                                    </div>
                                    <div class="comment-author" style="margin-left:16px;color:#888;font-size:13px;white-space:nowrap;">${escapeHtml(comment.author || '')}</div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
            } catch (error) {
                console.error('댓글 로드 실패:', error);
                
                if (commentsList) {
                    commentsList.innerHTML = '<div class="no-comments">아직 댓글이 없습니다. 첫 댓글을 작성해보세요!</div>';
                }
                if (commentCount) {
                    commentCount.textContent = '(0)';
                }
            }
        }

        // 댓글 작성 (Supabase 연결)
        async function submitComment(itemId) {
            // 안전한 ID로 변환
            const safeId = itemId.replace(/[^a-zA-Z0-9_-]/g, '_');
            const contentElement = document.getElementById(`comment-content-${safeId}`);
            const authorElement = document.getElementById(`comment-author-${safeId}`);
            
            if (!contentElement || !authorElement) {
                console.error('댓글 입력 요소를 찾을 수 없습니다');
                return;
            }
            
            const content = contentElement.value.trim();
            const author = authorElement.value.trim();
            
            if (!author) {
                alert('작성자 이름을 입력해주세요.');
                return;
            }
            if (!content) {
                alert('댓글 내용을 입력해주세요.');
                return;
            }
            if (content.length > 300) {
                alert('댓글은 300자 이내로 작성해주세요.');
                return;
            }
            
            try {
                // 전역 Supabase 클라이언트 사용
                const supabaseClient = getSupabaseClient();
                
                if (!supabaseClient) {
                    throw new Error('Supabase 클라이언트를 초기화할 수 없습니다.');
                }
                
                const { data, error } = await supabaseClient
                    .from('comments')
                    .insert([
                        {
                            item_id: itemId,
                            content: content,
                            author: author
                        }
                    ]);
                
                if (error) {
                    console.error('Supabase 오류:', error);
                    throw error;
                }
                
                // 댓글 입력창 초기화
                contentElement.value = '';
                authorElement.value = '';
                const charCount = document.getElementById(`char-count-${safeId}`);
                if (charCount) {
                    charCount.textContent = '0/300';
                    charCount.className = 'char-count';
                }
                
                const submitBtn = contentElement.parentElement.querySelector('.comment-submit');
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                
                // 댓글 목록 새로고침
                await loadComments(itemId);
                
            } catch (error) {
                console.error('댓글 저장 실패:', error);
                alert('댓글 저장 중 오류가 발생했습니다.');
            }
        }

        // 전역 함수로 등록
        window.createCommentSection = createCommentSection;
        window.loadComments = loadComments;
        window.submitComment = submitComment;
        window.initSupabaseClient = initSupabaseClient;
        window.getSupabaseClient = getSupabaseClient;
    </script>
</head>
<body>
    <!-- 뒤로가기 버튼 -->
    <div id="back-button" onclick="goBack()" title="뒤로가기" aria-label="뒤로가기">
        <i class="fa-solid fa-house home-icon"></i>
    </div>

    <!-- 로딩 화면 -->
    <div id="loading-screen">
        <h1 class="loading-title">유치원급식 사생대회</h1>
        <div class="spinner"></div>
        <div class="progress-text" id="progress-text">Loading...</div>
        
        <!-- 로딩 중 조작 가이드 -->
        <div id="loading-controls" style="
            margin-top: 40px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 2s forwards;
        ">
            <div style="
                color: #666;
                font-size: 0.9rem;
                margin-bottom: 20px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                text-align: center;
            ">조작법을 미리 확인해보세요!</div>
            
            <div style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                max-width: 300px;
                margin: 0 auto;
            ">
                <!-- WASD 키 -->
                <div style="
                    text-align: center;
                    background: rgba(255, 255, 255, 0.1);
                    padding: 15px;
                    border-radius: 8px;
                ">
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(3, 14px);
                        gap: 2px;
                        justify-content: center;
                        margin-bottom: 10px;
                    ">
                        <div></div>
                        <div class="loading-key">W</div>
                        <div></div>
                        <div class="loading-key">A</div>
                        <div class="loading-key">S</div>
                        <div class="loading-key">D</div>
                    </div>
                    <div style="font-size: 0.75rem; color: #888;">이동하기</div>
                </div>
                
                <!-- 마우스 -->
                <div style="
                    text-align: center;
                    background: rgba(255, 255, 255, 0.1);
                    padding: 15px;
                    border-radius: 8px;
                ">
                    <div style="
                        width: 20px;
                        height: 28px;
                        background: rgba(255, 255, 255, 0.3);
                        border: 1px solid rgba(255, 255, 255, 0.5);
                        border-radius: 10px 10px 5px 5px;
                        margin: 0 auto 10px;
                        position: relative;
                    ">
                        <div style="
                            position: absolute;
                            top: 3px;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 1px;
                            height: 5px;
                            background: rgba(255, 255, 255, 0.7);
                        "></div>
                        <div style="
                            position: absolute;
                            top: 25px;
                            left: -15px;
                            width: 50px;
                            height: 2px;
                            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.8), transparent);
                            animation: loadingDrag 2s ease-in-out infinite;
                        "></div>
                    </div>
                    <div style="font-size: 0.75rem; color: #888;">둘러보기</div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes loadingKeyPress {
            0%, 80%, 100% { 
                background: rgba(255, 255, 255, 0.2);
                transform: scale(1);
            }
            10%, 20% { 
                background: rgba(99, 102, 241, 0.8);
                transform: scale(0.95);
            }
        }
        
        @keyframes loadingDrag {
            0%, 100% { transform: translateX(-10px); opacity: 0.3; }
            50% { transform: translateX(10px); opacity: 1; }
        }
        
        .loading-key {
            width: 14px;
            height: 14px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            font-weight: bold;
            color: #fff;
        }
        
        .loading-key:nth-child(2) { /* W */
            animation: loadingKeyPress 3s ease-in-out infinite;
        }
        
        .loading-key:nth-child(4) { /* A */
            animation: loadingKeyPress 3s ease-in-out infinite 0.75s;
        }
        
        .loading-key:nth-child(6) { /* D */
            animation: loadingKeyPress 3s ease-in-out infinite 1.5s;
        }
        
        .loading-key:nth-child(5) { /* S */
            animation: loadingKeyPress 3s ease-in-out infinite 2.25s;
        }
    </style>

    <!-- 갤러리 컨텐츠 -->
    <!-- <div class="background_menu">
        <div id="menu">
            <div id="img_container">
                <img src="./img/test.jpg" alt="menu pic">
            </div>

            <div id="content">
                <h1>유치원급식 사생대회</h1>
                <div>
                    <p> This is an interctive 3D gallery</p>
                    <p> You can view the gallery in 3D and also buy the art pieces</p>
            </div>

            <div>
                <p>Instructions</p>
                <p>Arrow Keys</p>
                <p>Look around with mouse</p>
            </div>

            <div id="play_button">
                <p>Enter The Gallery</p>
            </div> -->
        <!-- </div> -->
        <div id="painting-info"></div>
    </div>

    <script type="importmap">
        {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.173.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/"
        }
        }
    </script>

    <script>
        // 뒤로가기 함수
        function goBack() {
            window.location.href = 'https://유치원급식사생대회.com';
        }

        // 모바일 터치 이벤트도 뒤로가기 버튼에 추가
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase 클라이언트 초기화
            initSupabaseClient();
            
            // 댓글 함수들을 전역에서 확실히 접근할 수 있도록 재등록
            window.createCommentSection = createCommentSection;
            window.loadComments = loadComments;
            window.submitComment = submitComment;
            
            // console.log('댓글 함수들이 전역에 등록되었습니다:', {
            //     createCommentSection: typeof window.createCommentSection,
            //     loadComments: typeof window.loadComments,
            //     submitComment: typeof window.submitComment
            // });
            
            const backBtn = document.getElementById('back-button');
            if (backBtn) {
                backBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    goBack();
                }, { passive: false });
            }
        });

        // 로딩 진행률 업데이트 함수
        function updateLoadingProgress(progress) {
            const progressText = document.getElementById('progress-text');
            
            if (progressText) {
                const percentage = Math.round(progress * 100);
                progressText.textContent = `Loading... ${percentage}%`;
            }
        }

        // 로딩 완료 함수
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('fade-out');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        }

        // 글로벌 함수로 등록하여 main.js에서 사용할 수 있게 함
        window.updateLoadingProgress = updateLoadingProgress;
        window.hideLoadingScreen = hideLoadingScreen;
    </script>

    <!-- 기존 joystick-container 부분을 이것으로 교체하세요 -->
<div id="joystick-container" style="position:fixed;left:20px;bottom:20px;width:120px;height:120px;z-index:1000;touch-action:none;display:none;">
    <div id="joystick" style="width:80px;height:80px;background:#ffffff;border-radius:50%;position:absolute;left:20px;top:20px;box-shadow:0 2px 8px rgba(0,0,0,0.15);border:2px solid #e0e0e0;"></div>
    <div id="joystick-knob" style="width:32px;height:32px;background:#6366f1;border-radius:50%;position:absolute;left:40px;top:40px;transform:translate(-16px,-16px);cursor:grab;box-shadow:0 2px 6px rgba(99,102,241,0.3);transition:transform 0.1s ease;"></div>
</div>

    <style>
        /* 기본적으로 조이스틱 숨김 */
        #joystick-container {
            display: none !important;
        }
        
        /* 모바일 디바이스에서만 조이스틱 표시 (JavaScript에서 제어) */
        #joystick-container.mobile-only {
            display: block !important;
        }
    </style>

    <script src="./js/main.js" type="module" defer></script>
    <script src="./js/controlGuide.js" type="module"></script>
    <script>
    // 모바일 터치 이벤트도 ?(도움말) 버튼에 추가
    document.addEventListener('DOMContentLoaded', function() {
        const helpBtn = document.getElementById('help-button');
        if (helpBtn) {
            helpBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                helpBtn.click();
            }, { passive: false });
        }
    });
    
    // 동적으로 생성되는 help-button에도 적용
    const observer = new MutationObserver(() => {
        const helpBtn = document.getElementById('help-button');
        if (helpBtn && !helpBtn._touchAdded) {
            helpBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                helpBtn.click();
            }, { passive: false });
            helpBtn._touchAdded = true;
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>

</html>


