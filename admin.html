<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>댓글 관리 - 관리자</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.4;
            font-size: 13px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .header p {
            font-size: 13px;
            color: #7f8c8d;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex: 1;
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .comments-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .comment-content {
            max-width: 250px;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 12px;
        }

        .comment-date {
            font-size: 11px;
            color: #7f8c8d;
        }

        .comment-author {
            font-weight: 500;
            color: #2c3e50;
            font-size: 12px;
        }

        .comment-item {
            font-size: 11px;
            color: #3498db;
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .no-comments {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .page-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .stats {
                flex-direction: column;
            }

            table {
                font-size: 12px;
            }

            .comment-content {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>댓글 관리</h1>
            <p>유치원급식 사생대회 댓글을 관리할 수 있습니다.</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-comments">-</div>
                <div class="stat-label">전체 댓글</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="today-comments">-</div>
                <div class="stat-label">오늘 댓글</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unique-items">-</div>
                <div class="stat-label">댓글이 있는 작품</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="search-box" placeholder="댓글 내용, 작성자, 작품명으로 검색...">
            <button class="btn btn-primary" onclick="searchComments()">검색</button>
            <button class="btn btn-secondary" onclick="loadAllComments()">전체보기</button>
            <button class="btn btn-danger" onclick="deleteSelectedComments()">선택삭제</button>
        </div>

        <div class="comments-table">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                        <th>작품/사례</th>
                        <th>작성자</th>
                        <th>댓글 내용</th>
                        <th>작성일시</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody id="comments-tbody">
                    <tr>
                        <td colspan="6" class="loading">
                            댓글을 불러오는 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        // Supabase 클라이언트 초기화
        const SUPABASE_URL = 'https://pimgwrosozsowpetqeeq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpbWd3cm9zb3pzb3dwZXRxZWVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MTcxMjgsImV4cCI6MjA3MDk5MzEyOH0.VKEsxMu47TDVvV93Gy9I-z4UmfNYlNEhSYkBSS5vDqU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allComments = [];
        let filteredComments = [];
        let currentPage = 1;
        const itemsPerPage = 20;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadAllComments();
            
            // 검색박스 엔터 키 이벤트
            document.getElementById('search-box').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchComments();
                }
            });
        });

        // 모든 댓글 로드
        async function loadAllComments() {
            try {
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('댓글 로드 오류:', error);
                    return;
                }

                allComments = comments;
                filteredComments = comments;
                updateStats();
                renderComments();
                
            } catch (error) {
                console.error('댓글 로드 실패:', error);
                document.getElementById('comments-tbody').innerHTML = `
                    <tr><td colspan="6" class="no-comments">댓글을 불러오는데 실패했습니다.</td></tr>
                `;
            }
        }

        // 통계 업데이트
        function updateStats() {
            const total = allComments.length;
            const today = new Date().toDateString();
            const todayComments = allComments.filter(comment => 
                new Date(comment.created_at).toDateString() === today
            ).length;
            const uniqueItems = new Set(allComments.map(comment => comment.item_id)).size;

            document.getElementById('total-comments').textContent = total;
            document.getElementById('today-comments').textContent = todayComments;
            document.getElementById('unique-items').textContent = uniqueItems;
        }

        // 댓글 검색
        function searchComments() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredComments = allComments;
            } else {
                filteredComments = allComments.filter(comment => 
                    comment.content.toLowerCase().includes(searchTerm) ||
                    comment.author.toLowerCase().includes(searchTerm) ||
                    comment.item_id.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 1;
            renderComments();
        }

        // 댓글 렌더링
        function renderComments() {
            const tbody = document.getElementById('comments-tbody');
            
            if (filteredComments.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="no-comments">댓글이 없습니다.</td></tr>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // 페이지네이션 계산
            const totalPages = Math.ceil(filteredComments.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const commentsToShow = filteredComments.slice(startIndex, endIndex);

            // 댓글 렌더링
            tbody.innerHTML = commentsToShow.map(comment => {
                const date = new Date(comment.created_at).toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const itemName = getItemDisplayName(comment.item_id);

                return `
                    <tr>
                        <td><input type="checkbox" class="comment-checkbox" value="${comment.id}"></td>
                        <td><span class="comment-item">${itemName}</span></td>
                        <td class="comment-author">${escapeHtml(comment.author)}</td>
                        <td class="comment-content">${escapeHtml(comment.content)}</td>
                        <td class="comment-date">${date}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteComment(${comment.id})">삭제</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // 페이지네이션 렌더링
            renderPagination(totalPages);
        }

        // 작품명 표시용 변환
        function getItemDisplayName(itemId) {
            if (itemId.startsWith('case_')) {
                const folderName = itemId.replace('case_', '');
                const folderDisplayNames = {
                    '더그림': '더그림유치원 사례',
                    '송랑': '송랑유치원 사례',
                    '순천': '순천북유치원 사례',
                    '옥산유': '옥산유유치원 사례',
                    '굿모닝': '굿모닝유치원 사례'
                };
                return folderDisplayNames[folderName] || itemId;
            }
            
            // 일반 작품인 경우 파일명에서 작품명 추출
            const fileName = itemId.split('/').pop();
            if (fileName) {
                return fileName.replace('_optimized.jpg', '').replace('.jpg', '');
            }
            
            return itemId;
        }

        // 페이지네이션 렌더링
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // 이전 버튼
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})">이전</button>`;
            }

            // 페이지 번호
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            // 다음 버튼
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})">다음</button>`;
            }

            pagination.innerHTML = paginationHTML;
        }

        // 페이지 변경
        function changePage(page) {
            currentPage = page;
            renderComments();
        }

        // 전체 선택/해제
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.comment-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // 선택된 댓글 삭제
        async function deleteSelectedComments() {
            const checkboxes = document.querySelectorAll('.comment-checkbox:checked');
            const commentIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (commentIds.length === 0) {
                alert('삭제할 댓글을 선택해주세요.');
                return;
            }

            if (!confirm(`선택된 ${commentIds.length}개의 댓글을 삭제하시겠습니까?`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('comments')
                    .delete()
                    .in('id', commentIds);

                if (error) {
                    console.error('댓글 삭제 오류:', error);
                    alert('댓글 삭제 중 오류가 발생했습니다.');
                    return;
                }

                alert(`${commentIds.length}개의 댓글이 삭제되었습니다.`);
                loadAllComments();
                
            } catch (error) {
                console.error('댓글 삭제 실패:', error);
                alert('댓글 삭제 중 오류가 발생했습니다.');
            }
        }

        // 개별 댓글 삭제
        async function deleteComment(commentId) {
            if (!confirm('이 댓글을 삭제하시겠습니까?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('comments')
                    .delete()
                    .eq('id', commentId);

                if (error) {
                    console.error('댓글 삭제 오류:', error);
                    alert('댓글 삭제 중 오류가 발생했습니다.');
                    return;
                }

                alert('댓글이 삭제되었습니다.');
                loadAllComments();
                
            } catch (error) {
                console.error('댓글 삭제 실패:', error);
                alert('댓글 삭제 중 오류가 발생했습니다.');
            }
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
    </script>
</body>
</html>
